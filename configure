#!/bin/bash

usage() {
    echo "Usage: configure <path to patched qemu source code> <target>"
}

if [[ $# != 2 ]]; then
    usage
    exit 1
fi

target=$2
qemusrc=`cd $1; pwd`
coremuroot=`pwd`

mkdir -p obj/qemu
mkdir -p bin/qemu

echo "QEMUSRC := ${qemusrc}" > coremu.mk
echo "TARGET := ${target}" >> coremu.mk
echo "COREMU_LIB = ${coremuroot}/obj/libcoremu.a" > ${qemusrc}/coremu.mk

echo '***** [QEMU-git for COREMU build] *****'

cd ${coremuroot}/obj/qemu
${qemusrc}/configure --prefix=${coremuroot}/bin/qemu \
    --disable-kvm \
    --disable-docs \
    --extra-cflags="-I${coremuroot}/incl \
            -I${coremuroot}/obj/qemu \
            -I${coremuroot}/obj/qemu/${target}-softmmu" \
    --target-list="${target}-softmmu" \
    --disable-werror \
    --enable-debug 

make config-host.h
cd ${target}-softmmu
make config-target.h

