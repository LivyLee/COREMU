#!/bin/sh

usage() {
    cat <<EOF
Usage: ./configure [options] <qemusrc>

Options:
    --prefix=<path>    Install location, default is ./bin
    --use-lockfree         Use lock free concurrent queue instead of lock based version.
    --target=<target>  Targets will be built, supports x86_64 and arm. x86_64 is default.
                       This option can be used for more than one time to build
                       more than one target.
EOF
}

# parse options
for opt do
  optarg=`expr "x$opt" : 'x[^=]*=\(.*\)'`
  case "$opt" in
    --prefix=*) prefix="$optarg"
    ;;
    --qemusrc=*) qemusrc="$optarg"
    ;;
    --use-lockfree) lockfree="true"
    ;;
    --target=*)
    if [ -z $target ]; then
      target="$optarg-softmmu"
    else
      target=$target",$optarg-softmmu"
    fi
    ;;
    --help)
    usage
    exit 0
    ;;
    *) qemusrc=$opt
    ;;
  esac
done

if [ -z $qemusrc ]; then
  usage
  exit 1
fi

if [ -z $target ]; then
  target="x86_64-softmmu"
fi

if [ -z $prefix ]; then
  prefix=`pwd`/bin
fi

coremuroot=`pwd`
# absolute path to qemu src
qemusrc=`cd $qemusrc; pwd`

echo '***** [QEMU-git for COREMU build] *****'
echo "target:    $target"
echo "prefix:    $prefix"
echo "qemusrc:   $qemusrc"
echo "lockfree: $lockfree"
#exit 1

mkdir -p obj/qemu

echo "QEMUSRC := ${qemusrc}" > coremu.mk
echo "TARGET := ${target}" >> coremu.mk
echo "PREFIXDIR := ${prefix}" >> coremu.mk
if [ -n $lockfree  ]; then
  echo "LOCKFREE := true" >> coremu.mk
fi

echo "COREMU_LIB = ${coremuroot}/obj/libcoremu.a" > ${qemusrc}/coremu.mk

cd ${coremuroot}/obj/qemu
${qemusrc}/configure --prefix=${prefix} \
    --disable-kvm \
    --disable-docs \
    --extra-cflags="-I${coremuroot}/incl -g" \
    --target-list="${target}" \
    --disable-werror \
